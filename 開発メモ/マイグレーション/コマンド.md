# Flask-Migrate
## äº‹å‰æº–å‚™

### Flask-Migrate ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã¾ã ãªã‚‰ï¼‰ï¼š
    pip install Flask-Migrate

### app.pyã«ä»¥ä¸‹ã‚’è¿½åŠ 
    from flask_migrate import Migrate
    migrate = Migrate(app, db)

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã§ä»¥ä¸‹ã‚’æ‰“ã¤ï¼ˆ= ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ»ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸Šï¼‰
    flask db init
â€»ã“ã‚Œã¯ã€Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ã€ã§æ‰“ã¡ã¾ã™ã€‚Pythonå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚


### åˆå›èµ·å‹•æ™‚ã®å‡¦ç†
`æœ€åˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã›ã‚‹ã‚ˆã†ã«ã€åˆæœŸçŠ¶æ…‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ`
    flask db migrate -m "initial"


## ã‚«ãƒ©ãƒ è¿½åŠ æ™‚ã®æ“ä½œï¼ˆæ¯å›ï¼‰
â€»ä¸‹è¨˜2ã¤ã‚‚ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ã§æ‰“ã¤ã‚³ãƒãƒ³ãƒ‰ ã§ã™ã€‚
### ãƒ¢ãƒ‡ãƒ«ã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ãŸã‚ã¨ï¼š
    flask db migrate -m "add age column to user"

### è¿½åŠ ã‚’å®Ÿéš›ã®DBã«åæ˜ 
    flask db upgrade

## æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã—ãŸã‚«ãƒ©ãƒ ã«å…¥ã‚‹å€¤ã®å‡¦ç†
SQLiteã§ ALTER TABLE ã™ã‚‹ã¨ãã« NOT NULL åˆ¶ç´„ã‚’ã¤ã‘ã¦ã„ã‚‹ã®ã« DEFAULT ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ã¨ã€
SQLiteã€Œæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«NULLã‚’å…¥ã‚Œã‚‹ã‚ã‘ã«ã¯ã„ã‹ã‚“ã‚ˆï¼ã€â†’ 

    OperationalError: Cannot add a NOT NULL column with default value NULL

### è©²å½“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™
ï¼ˆä¾‹ï¼šmigrations/versions/bdd19fa63016_add_column_puroduct_number_tb.pyï¼‰
op.add_column ã®ã¨ã“ã‚ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ï¼š

    with op.batch_alter_table('product_number') as batch_op:
        batch_op.add_column(sa.Column('serial_no', sa.String(length=20), nullable=False, server_default=''))
ğŸ”¸ server_default='' ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€SQLiteã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã§ãã¾ã™ã€‚
â€»server_default ã¯ã€SQLã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæ–‡å­—åˆ—ï¼‰ã‚„SQLAlchemyã®å¼ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
Pythonã® True ã‚„ False ã‚’ç›´æ¥æ¸¡ã™ã®ã¯NGã€‚
SQLiteã§ã¯ 0ï¼ˆå½ï¼‰ã€1ï¼ˆçœŸï¼‰`falseã®å ´åˆ` : `server_default=sa.text('0')`
æ—¥æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã€ŒSQLå´ã§æŒ‡å®šã€ã™ã‚‹
SQLiteã®å ´åˆã€ç¾åœ¨æ—¥æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ CURRENT_TIMESTAMP ã§ã™
server_default=sa.text('CURRENT_TIMESTAMP')

### ä¿å­˜ã—ãŸã‚‰å†åº¦å®Ÿè¡Œ
    flask db upgrade



#### SQLiteã«ãŠã‘ã‚‹æ³¨æ„ç‚¹
SQLiteã§ã¯DDLãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å·»ãè¾¼ã¾ã‚Œãªã„
SQLiteã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ï¼ˆDDLï¼‰ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä¸€è²«ã—ã¦æ‰±ã‚ã‚Œãªã„ã¨ã„ã†åˆ¶é™ãŒã‚ã‚Šã¾ã™ï¼š
ALTER TABLE
CREATE TABLE
DROP TABLE
ADD COLUMN ãªã©
ãã®ãŸã‚ã€AlembicãŒè¤‡æ•°ã®DDLæ–‡ã‚’é †ã«å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ãŸ
æœ€åˆã®ã‚«ãƒ©ãƒ è¿½åŠ ã ã‘ã¯æˆåŠŸã—ã¦ã„ãŸï¼ˆç¢ºå®šæ¸ˆã¿ï¼‰
ãã®å¾Œã®åˆ¥å‡¦ç†ï¼ˆãŸã¨ãˆã°å¤–éƒ¨ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ã‚„é‡è¤‡è¿½åŠ ï¼‰ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸ
ã§ã‚‚ã™ã§ã«å‰åŠã®DDLï¼ˆADD COLUMNï¼‰ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œãšã«æ®‹ã£ã¦ã„ã‚‹
ã¨ã„ã†çµæœãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚


```py
"""add_column

Revision ID: 9490a5a8896f
Revises: 
Create Date: 2025-11-07 14:35:37.639174

"""
from alembic import op
import sqlalchemy as sa
from datetime import timezone,timedelta,datetime


# revision identifiers, used by Alembic.
revision = '9490a5a8896f'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # cellãƒ†ãƒ¼ãƒ–ãƒ«
    # op.add_column('cell', sa.Column('is_deleted', sa.Boolean(), nullable=True, server_default=sa.text('0')))
    op.add_column('cell', sa.Column('created_at', sa.DateTime(), nullable=True))
    op.add_column('cell', sa.Column('updated_at', sa.DateTime(), nullable=True))
    op.execute("UPDATE cell SET created_at = CURRENT_TIMESTAMP WHERE created_at IS NULL")
    op.execute("UPDATE cell SET updated_at = CURRENT_TIMESTAMP WHERE updated_at IS NULL")
    # shelfãƒ†ãƒ¼ãƒ–ãƒ«
    op.add_column('shelf', sa.Column('is_deleted', sa.Boolean(), nullable=True, server_default=sa.text('0')))
    op.add_column('shelf', sa.Column('created_at', sa.DateTime(), nullable=True))
    op.add_column('shelf', sa.Column('updated_at', sa.DateTime(), nullable=True))
    op.execute("UPDATE shelf SET created_at = CURRENT_TIMESTAMP WHERE created_at IS NULL")
    op.execute("UPDATE shelf SET updated_at = CURRENT_TIMESTAMP WHERE updated_at IS NULL")
    # zoneãƒ†ãƒ¼ãƒ–ãƒ«
    op.add_column('zone', sa.Column('is_deleted', sa.Boolean(), nullable=True, server_default=sa.text('0')))
    op.add_column('zone', sa.Column('created_at', sa.DateTime(), nullable=True))
    op.add_column('zone', sa.Column('updated_at', sa.DateTime(), nullable=True))
    op.execute("UPDATE zone SET created_at = CURRENT_TIMESTAMP WHERE created_at IS NULL")
    op.execute("UPDATE zone SET updated_at = CURRENT_TIMESTAMP WHERE updated_at IS NULL")


def downgrade():
    op.drop_column('cell', 'updated_at')
    op.drop_column('cell', 'created_at')
    op.drop_column('cell', 'is_deleted')

    op.drop_column('shelf', 'updated_at')
    op.drop_column('shelf', 'created_at')
    op.drop_column('shelf', 'is_deleted')

    op.drop_column('zone', 'updated_at')
    op.drop_column('zone', 'created_at')
    op.drop_column('zone', 'is_deleted')
    # ### end Alembic commands ###

```